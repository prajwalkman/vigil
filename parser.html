<!DOCTYPE html>

<html>
<head>
  <title>Parser</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="public/stylesheets/normalize.css" />
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div class="container">
    <div class="page">

      <div class="header">
        
          
          <h1>Parser</h1>

          
        

        
          <div class="toc">
            <h3>Table of Contents</h3>
            <ol>
              
              
                
                
                
                  
                
              
                
                
                
              
                
                
                
              
                
                
                
              
                
                
                
              
                
                
                
              
                
                
                  
                
                
              
                
                
                
              
              
              
              
                
                <li>
                  <a class="source" href="README.html">
                    README.md
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="parser.html">
                    src/config/parser.litcoffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="dependencies.html">
                    src/dependencies.litcoffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="index.html">
                    src/index.litcoffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="overseer.html">
                    src/overseer.litcoffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="services.html">
                    src/services.litcoffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="workers.html">
                    src/workers.litcoffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="CONTRIBUTING.html">
                    CONTRIBUTING.md
                  </a>
                </li>
              
            </ol>
          </div>
        
      </div>

      
        
        <h2>Overview</h2>

        
      
        
        <p>This is used to parse configuration files written in our DSL.</p>
<hr>
<h2>Source-through</h2>

        
      
        
        <p>We will compile the config file programmatically using coffee-script to its equivalent javascript. We also use <code>Q</code> promise objects to simplify both the API and the unit tests.</p>

        
          <div class='highlight'><pre>coffee = require <span class="string">'coffee-script'</span>
fs     = require <span class="string">'fs'</span>
path   = require <span class="string">'path'</span>
vm     = require <span class="string">'vm'</span>
q      = require <span class="string">'q'</span></pre></div>
        
      
        
        <p>The sandbox object contains the functions required for parsing the contents of the config file.</p>

        
          <div class='highlight'><pre>sandbox =
    as: (val) -&gt; val: val</pre></div>
        
      
        
        <p>We evaluate the generated javascript in the context of the sandbox, and return the result. Errors cause the promise to be rejected.</p>

        
          <div class='highlight'><pre><span class="function"><span class="title">parser</span></span> = (file) -&gt;
    deferred = q.defer()
    fs.readFile path.resolve(file), (err, data) -&gt;
        <span class="keyword">if</span> err
            deferred.reject err
        <span class="keyword">else</span>
            <span class="keyword">try</span>
                compiled_javascript = coffee.compile data.toString(), bare: <span class="literal">true</span>
            <span class="keyword">catch</span> compile_error
                deferred.reject compile_error
            result = vm.runInNewContext compiled_javascript, sandbox
            deferred.resolve result
    <span class="keyword">return</span> deferred.promise

module.exports = parser</pre></div>
        
      
      <div class="fleur">h</div>
    </div>
  </div>
</body>
</html>
<!DOCTYPE html>

<html>
<head>
  <title>Overseer</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="public/stylesheets/normalize.css" />
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div class="container">
    <div class="page">

      <div class="header">
        
          
          <h1>Overseer</h1>

          
        

        
          <div class="toc">
            <h3>Table of Contents</h3>
            <ol>
              
              
                
                
                
                  
                
              
                
                
                
              
                
                
                
              
                
                
                
              
                
                
                
              
                
                
                
              
                
                
                  
                
                
              
                
                
                
              
              
              
              
                
                <li>
                  <a class="source" href="README.html">
                    README.md
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="parser.html">
                    src/config/parser.litcoffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="dependencies.html">
                    src/dependencies.litcoffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="index.html">
                    src/index.litcoffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="overseer.html">
                    src/overseer.litcoffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="services.html">
                    src/services.litcoffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="workers.html">
                    src/workers.litcoffee
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="CONTRIBUTING.html">
                    CONTRIBUTING.md
                  </a>
                </li>
              
            </ol>
          </div>
        
      </div>

      
        
        <h2>Overview</h2>

        
      
        
        <p>This module oversees the creation and maintenance of the Vigil process cluster. It spins off child processes which each perform a specific role (server, monitor, etc). Each worker runs in a <code>domain</code>. When the worker encounters an uncaught exception, it is allowed to gracefully die, and a new fork is created here to replace it.</p>
<hr>
<h2>Source-through</h2>

        
      
        
        <p>First, require the cluster module, and the list of well defined worker roles.</p>

        
          <div class='highlight'><pre>cluster = require <span class="string">'cluster'</span>
{roles} = require <span class="string">'./config'</span>

workers = {}</pre></div>
        
      
        
        <p>This sets the configuration for <code>cluster.fork()</code>.</p>
<blockquote>
<p>The new settings are effective immediately and permanently, they cannot be changed later on.</p>
</blockquote>

        
          <div class='highlight'><pre>overseerConfig =
    exec:   require.resolve(<span class="string">'./workers'</span>)
    args:   []
    silent: <span class="literal">false</span>

cluster.setupMaster overseerConfig</pre></div>
        
      
        
        <p>The <code>resurrectionHandler</code> is called when a worker dies. We figure out it&#39;s role form <code>worker.id</code> and fork() a new worker of that role to replace the dead one.</p>

        
          <div class='highlight'><pre><span class="function"><span class="title">resurrectionHandler</span></span> = (worker, code, signal) -&gt;
    workerRole = <span class="string">'runner'</span>
    workerId = worker.id
    console.log <span class="string">"Worker {ID: <span class="subst">#{workerId}</span>, ROLE: <span class="subst">#{workerRole}</span>} has died. Restarting..."</span>
    workers[workerRole] = cluster.fork role: workerRole</pre></div>
        
      
        
        <p>A callback to ensure graceful death of the master process.</p>

        
          <div class='highlight'><pre><span class="function"><span class="title">masterExitHandler</span></span> = -&gt;
    console.log <span class="string">"\nVigil is quitting."</span></pre></div>
        
      
        
        <p>We can set environment variables for the child while forking. Here, we set the <code>role</code> environment variable so the worker knows what it&#39;s supposed to do. We loop through <code>roles</code> creating a worker for each, and storing their reference in the hash table <code>workers</code>.</p>

        
          <div class='highlight'><pre><span class="function"><span class="title">start</span></span> = -&gt;
    workers[role] = cluster.fork {role} <span class="keyword">for</span> role <span class="keyword">in</span> roles

    cluster.<span class="literal">on</span> <span class="string">'exit'</span>, resurrectionHandler

    process.<span class="literal">on</span> <span class="string">'SIGINT'</span>, -&gt;
        process.exit <span class="number">1</span>

    process.<span class="literal">on</span> <span class="string">'exit'</span>, masterExitHandler

    <span class="keyword">return</span> {process, cluster}

<span class="keyword">if</span> require.main <span class="keyword">is</span> module
    start()
<span class="keyword">else</span>
    module.exports = start</pre></div>
        
      
      <div class="fleur">h</div>
    </div>
  </div>
</body>
</html>